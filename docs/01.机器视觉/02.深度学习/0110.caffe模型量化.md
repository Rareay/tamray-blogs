---
title: caffe模型量化
date: 2020-5-11 09:20:00
permalink: /pages/eb8080/
categories: 
  - 机器视觉
  - 深度学习
tags: 
  - 
---


## 1 使用 caffe-int-convert-tools 量化

- 下载
  ```shell
  git clone https://github.com/BUG1989/caffe-int8-convert-tools.git
  # wget https://github.com/BUG1989/caffe-int8-convert-tools/archive/master.zip
  ```

- 准备文件
  ```shell
  test/
  ├── images
  │   ├── 001.jpeg
  │   ├── 002.jpeg
  │   └── 003.jpeg
  └── models
      ├── ResNet_50_train.prototxt
      └── ResNet_50.caffemodel
  ```

- 执行
  ```shell
  python caffe-int8-convert-tools/caffe-int8-convert-tool-dev-weight.py \
      --proto=model_resnet/ResNet_50_train.prototxt \
      --model=model_resnet/ResNet_50.caffemodel \
      --mean 127.5 127.5 127.5 \
      --norm=0.00777 \
      --images=caffe-int8-convert-tools/test/images/ \
      --output=caffe-int8-convert-tools/test/ResNet_50.table \
      --gpu=1
  ```
  其中，output 参数是生成的 `.table` 文件。

- 执行遇到问题1
  ```shell
  执行 np.set_printoptions(threshold=np.nan) 报错
  ``` 
  解决:将其改为 `np.set_printoptions(threshold=np.inf)`，是版本问题。


- 执行遇到问题2
  ```shell
  TypeError: _open() got an unexpected keyword argument 'as_grey'
  ```

  解决:浏览错误信息，找到包含 `as_grey` 字符的文件，打开该文件，修改 `as_grey` 为 `as_gray` 即可，是版本问题。

如果上面步骤执行完会在指定路径产生 `.table` 文件。


## 2 转换为 ncnn 模型

[参考这里](https://blog.csdn.net/soralaro/article/details/81131615)


- 下载
  ```shell
  git clone https://github.com/Tencent/ncnn.git
  # wget https://github.com/Tencent/ncnn/archive/master.zip
  ```

- 编译
  ```shell
  cd ncnn
  mkdir build && cd build
  cmake ..
  make -j8
  make install
  ```
  编译完成后，会在 `./ncnn/build/tools` 目录下生成 `caffe/caffe2ncnn` 和 `ncnn2mem` 可执行程序。
  > caffe2ncnn 是将 caffe 模型转换为 ncnn 模型；
  > ncnn2mem 可以对 ncnn 模型加密（本文省略）；

- caffe 转换为 ncnn
  ```shell
  ./ncnn/build/tools/caffe/caffe2ncnn \
      model_resnet/ResNet_50_train.prototxt \
      model_resnet/ResNet_50.caffemodel \
      caffe-int8-convert-tools/test/ResNet_50-int8.param \
      caffe-int8-convert-tools/test/ResNet_50-int8.bin \
      256 \
      caffe-int8-convert-tools/test/ResNet_50.table 
  ```
  会生成 `ResNet_50-int8.param` 和 `ResNet_50-int8.bin`。

- 调用 ncnn 模型
  
  内容参考 ncnn 源码：`./ncnn/examples/squeezenet.cpp`。需要的头文件和库文件在 `./ncnn/build/install` 中，编译时需要添加。实现代码:
  ```cpp
  static int detect_mobileNet(const cv::Mat& bgr, std::vector<float>& cls_scores)
  {
      ncnn::Net mobileNet;
      mobileNet.load_param("/Users/Guigu/Documents/projects/ncnn_mobileNet/mobilenet.param");
      mobileNet.load_model("/Users/Guigu/Documents/projects/ncnn_mobileNet/mobilenet.bin");
   
      ncnn::Mat in = ncnn::Mat::from_pixels_resize(bgr.data, ncnn::Mat::PIXEL_BGR, bgr.cols, bgr.rows, 224, 224);
   
      const float mean_vals[3] = {103.94f, 116.78f, 123.68f};
      const float norm_vals[3] = {0.017f,0.017f,0.017f};
      in.substract_mean_normalize(mean_vals, norm_vals);
   
   
      ncnn::Extractor ex = mobileNet.create_extractor();
      ex.set_light_mode(true);
   
      ex.input("data", in);
   
      ncnn::Mat out;
      ex.extract("fc7", out);  //此处与squeezenet不同
   
      cls_scores.resize(out.c);
      for (int j=0; j<out.c; j++)
      {
          const float* prob = out.data + out.cstep * j;
          cls_scores[j] = prob[0];
      }
   
      return 0;
  }
  ```
  
  
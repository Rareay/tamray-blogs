---
title: SLAM知识点
date: 2020-08-28 15:49:54
permalink: /pages/9fc2c3/
categories: 
  - 机器视觉
  - Slam
tags: 
  - slam
  - 矩阵变换
  - 李群
---
# SLAM知识点

## 1 SLAM实验环境

|操作系统：|Ubuntu16 / Ubuntu18|
|--|--|
|编译工具：|cmake|
|依赖库：|Eigen、Sophus、|

## 2 三维空间刚体运动

<iframe src='/markmap/001.html' width='100%' height='300' frameborder='0'/>

### 2.1 旋转矩阵（R: 3x3）
假设坐标系从 $e$ 经过了欧式变换后，其正交基向量从 $\begin{bmatrix}e_1, e_2, e_3\end{bmatrix}$ 变成了 $\begin{bmatrix}e_1' , e_2' , e_3' \end{bmatrix}$，在变换中存在一个向量 $a$，其坐标从 $\begin{bmatrix}a_1\\a_2\\a_3\end{bmatrix}$ 变成了  $\begin{bmatrix}a_1' \\a_2' \\a_3' \end{bmatrix}$，所以满足关系：
$$\begin{bmatrix}e_1, e_2, e_3\end{bmatrix}\begin{bmatrix}a_1\\a_2\\a_3\end{bmatrix} = \begin{bmatrix}e_1' , e_2' , e_3' \end{bmatrix}\begin{bmatrix}a_1' \\a_2' \\a_3' \end{bmatrix} $$
可以转换成：
$$a = \begin{bmatrix}a_1\\a_2\\a_3\end{bmatrix} = \begin{bmatrix}e_1^Te_1'  & e_1^Te_2' &e_1^Te_3' \\e_2^Te_1' &e_2^Te_2' &e_2^Te_3' \\e_3^Te_1' &e_3^Te_3' &e_1^Te_3' \end{bmatrix} \begin{bmatrix}a_1' \\a_2' \\a_3' \end{bmatrix} = Ra'  $$
这里的 $R$ 称为`旋转矩阵`，它是一个行列式为1的正交矩阵（即逆为自身转置的矩阵），则反向旋转有：
$$a' = R^{-1}a = R^Ta$$
如果要描述向量在空间中的欧式变换，还需要一个平移向量 $t$，因为 $R$ 只描述了旋转，所以向量 $a_1$ 到向量 $a_2$ 的欧式变换：
$$a_2 = Ra_1 + t$$

### 2.2 变换矩阵（T: 4x4）
上式的欧式变换用到了 $R$ 和 $t$，有两次变换就不是线性关系，但可以使用齐次坐标和变换矩阵来将它线性化，设`变换矩阵` $T$：
$$T = \begin{bmatrix}R&t\\0^T&1 \end{bmatrix}$$
对应的欧式变化如下：
$$\begin{bmatrix}a^2 \\1\end{bmatrix} = \begin{bmatrix}R&t\\0^T&0\end{bmatrix} \begin{bmatrix}a^1\\1\end{bmatrix} = T\begin{bmatrix}a^1\\1\end{bmatrix}$$


### 2.3 旋转向量和欧拉角
- 旋转向量
	旋转状态也可以用一个`旋转轴`$n$和`旋转角`$\theta$来描述，组合在一起为旋转向量 ($\scriptsize \theta n$)，它和旋转矩阵可以相互转化：
	旋转向量 -> 旋转矩阵：
	$$R = cos{\theta I} + (1-cos{\theta })nn^T+sin{\theta} \hat{n} $$
	旋转矩阵 -> 旋转向量：

	$$\begin{aligned} tr(R) &= cos{\theta}I + (1-cos{\theta})tr(nn^T) + sin\theta tr(\hat{n}) \\ &= 3cos{\theta} + (1 - cos{\theta}) \\ &= 1 + 2cos{\theta} \end{aligned}$$


	$$\theta = arccos{\frac{tr(R)-1}{2}}$$
	$$Rn=n$$
上面的 $\hat{n}$ 表示 $n$ 的反对称矩阵:
$$\hat{a} = \begin{bmatrix} 0 & -a_3 & a_2 \\ a_3 & 0 & -a_1 \\ -a_2 & a_1 & 0 \end{bmatrix}$$

- 欧拉角
	使用 $\begin{bmatrix}r , p , y\end{bmatrix}^T$ 来描述旋转，表示分别绕三个坐标轴旋转，不同的旋转顺序会导致结果不一样，如 $rpy$ 角的旋转顺序是 $ZYX$，欧拉角的缺点是存在`万象锁问题`；

### 2.4 四元数


$$q = \begin{bmatrix} s, v \end{bmatrix}^T, s = q_0\in \mathbb{R}, v = \begin{bmatrix}q_1, q_2, q_3\end{bmatrix}^T\in \mathbb{R}^3$$

四元数为复数，上式中，$s$ 为实部，$v$ 为虚部；

注：c++中的矩阵运算、旋转向量、欧拉角、四元数的转化可以使用Eigen库，参考[这里](/pages/d737be/)；

## 3 李群与李代数
### 3.1 李群


旋转矩阵构成`特殊正交群 SO(3)`，变换矩阵构成了`特殊欧式群 SE(3)`:
$$SO(3) = \{R\in \mathbb{R}^{3*3} \mid RR^T = I, det(R) = 1\}$$
$$SE(3) = \{T=\begin{bmatrix}R & t \\ 0^T & 1 \end{bmatrix}\in  \mathbb{R}^{4*4} \mid R \in SO(3), t \in \mathbb{R}^3\}$$
这类矩阵之所以称之为‘群’，是因为它们具有一些属性，比如它们相乘后还是属于一类：
$$R_1R_2 \in SO(3), T_1T_2 \in SE(3)$$
### 3.1 李代数
推导李代数可以由 $R(t)R(t)^T=I$ 式子引出，求导后在使用反对称矩阵、泰勒展开、微分方程的方法可以得到式子：
$$R(t)=exp(\hat{\phi_0}t)$$ 
即  $R =exp(\hat{\phi})$ ，这里的 $\phi$ 就是李代数；

李代数 $\mathtt{SO(3)}$:
$$\mathtt{SO(3)} = \{\phi \in \mathbb{R}^3, \Phi = \hat{\phi} \in  \mathbb{R}^{3*3} \}$$

李代数 $\mathtt{SE(3)}$:
$$\mathtt{SE(3)} = \{ \xi = \begin{bmatrix}\rho \\ \phi \end{bmatrix}\in \mathbb{R}^6, \rho \in \mathbb{R}^3, \phi \in \mathcal{\mathtt{SO}(3), \hat{\xi} = \begin{bmatrix} \hat{\phi} & \rho \\ 0^T & 0 \end{bmatrix} \in \mathbb{R}^{4*4}} \}$$

注：c++中的李群、李代数之间的转化可以使用Sophus库，参考[这里](/pages/6d1fa3/)；

## 4 相机与图像

<img src='/pic/023.png' width='800'/>

|参数|说明|
|:--|:--|
|$1/Z$|$Z$是物平面的深度，$X,Y$乘上$1/Z$后深度变成了1,即归一化|
|$f$|相机焦距|
|$\alpha , \beta$|缩放（把物理单位转换成像素单位）|
|$C_x,C_y$|平移|
|$K$|集成了$C_x,C_y,\alpha ,\beta$|
注:
$$K = \begin{bmatrix} f_x & 0 & C_x \\ 0 & f_y & C_y \\ 0 & 0 & 1 \end{bmatrix}, f_x=\alpha f, f_y = \beta f$$

坐标系转换公式：

$$ ZP_{uv} = Z \begin{bmatrix} u \\\ v \\\ 1 \end{bmatrix} = K(RP_w + t) = KTP_w$$
其中，$R$、$t$ 为位姿，$P_w$为世界坐标，$(RP_w+t)$是相机坐标，$K$ 为相机内参，$P_{uv}$ 为像素坐标，$(RP_w + t) / Z$是归一化坐标；

## 5 非线性优化

参考[这里](/pages/197aa0/)，使用 g2o 模块实现高斯牛顿法；

## 6 视觉里程计

视觉里程计的算法主要分为两大类：==特征点法== 和 ==直接法==。

:::tip
- 特征点法：是视觉里程计的主流方法，它具有对光照、动态物体不敏感的优势，是目前比较成熟的解决方案。
- 直接法：
:::

<iframe src='/markmap/002.html' width='100%' height='400' frameborder='0'/>

### 6.1 特征点法
特征点法首先是`提取`、`匹配`图像特征点，然后根据对应的点来`估计`两帧之间的相机运动和场景结构，从而实现一个`两帧间`视觉里程计。

估计运动有多种方法，其中，由于相机的原理不同，会采取不同的方法：
|相机类型|点类型|方法|
|--|--|--|
|单目|2D + 2D|对极几何|
|双目、RGB-D|3D + 3D|ICP|
|其他|3D + 2D|PnP|

#### 6.1.1 特征点
特征点指图像中一些`特别的地方`，比如：角点、区块、边缘，这些特征用于标记相邻图片的对应位置。所以第一步就是通过算法来计算出图像中的特征点，著名算法有：SIFT、SURF、ORB等，找出特征点后，更重要的是把对应的点匹配起来，匹配方法有`暴力匹配`、`快速近似最邻近`，相关的算法已经集成在 Opencv 中。

#### 6.1.2 2D-2D: 对极几何
- 对极约束
  
  <img src='/pic/022.png' width='500'/>

  图中：
  - $O_1$、$O_2$：相机中心
  - $I_1$、$I_2$：像平面
  - $p_1$、$p_2$：对应的特征点
  - $e_1$、$e_2$：对应的极点
  - $l_1$、$l_2$：对应的极线

  我们知道两个像素点 $p_1$、$p_2$ 的像素位置：
  $$ s_1 p_1 = KP, s_2 P_2 = K(RP + t) $$
  其中，$K$为相机内参矩阵，$R$、$t$ 为两个坐标系的相机运动。因为 $s_1P_1$ 和 $p_1$ 成投影关系，它们在齐次坐标下的意义是相等的，称这种相等关系为`尺度意义下相等`，记作：$sp \backsimeq p$，那么上面的投影关系可以写为：
  $$ p_1 \backsimeq KP, P_2 \backsimeq K(RP + t) $$
  现在取：
  $$x_1 = K^{-1}p_1, x2=K^{-1}p_2$$
  经过推倒可以得到一个式子：
  $$x_2^T \hat{t} R x_1 = 0$$
  带入 $x_1$、$x_2$ 得：
  $$p_2^T K^{-T} \hat{t} R K^{-1} p_1 = 0$$
  上面的两个式子都称为`对极约束`，它的几何意义是 $O_1$、$P$、$O_2$ 共面。我们从上式子中提取两个矩阵：`基础矩阵`$F$、`本质矩阵`$E$，于是可以进一步简化对极矩阵约束：
  $$E = \hat{t}R, F = K^{-T}EK^{-1}, x_2^T E x_1 = p_2^T F p_1 = 0$$
  对极约束简洁的给出了两个匹配点的空间位置关系，于是，相机位姿估计问题变成以下两步：
  1. 根据匹配点的像素位置求出 $E$ 或 $F$;
  2. 根据 $E$ 或 $F$ 求出 $R$，$t$。
- 本质矩阵
  本质矩阵 $E = \hat{t}R$，它是一个 3x3 的矩阵，有 9 个未知数，我们可以利用 $E$ 的线性性质来使用`八点法`求解。
  我们设一对匹配点，它们的归一化坐标为 $x_1 = \begin{bmatrix}u_1,v_1,1\end{bmatrix}^T$，$x_2 = \begin{bmatrix}u_2,v_2,1\end{bmatrix}^T$，根据对极约束，有：
  $$\begin{bmatrix}u_2,v_2,1\end{bmatrix}  \begin{bmatrix}e_1 & e_2 & e_3 \\ e_4 & e_5 & e_6 \\ e_7 & e_8 & e_9\end{bmatrix}^T  \begin{bmatrix}u_1 \\ v_1 \\ 1\end{bmatrix} = 0$$
  如果我们把矩阵 $E$ 展开，写成向量形式：
  $$e = \begin{bmatrix} e_1, e_2, e_3, e_4, e_5, e_6, e_7, e_8, e_9 \end{bmatrix}^T $$
  那么，对极约束改写成与$e$有关的形式：
  $$\begin{bmatrix} u_2u_1, u_2v_1, u_2, v_2u_1, v_2v_1, v_2, u_1, v_1,1 \end{bmatrix}e = 0$$
  上面的式子是关于一对点的约束，如果我们使用8对点，变成了线性方程组：
  $$\begin{bmatrix} u_2^1u_1^1 & u_2^1v_1^1 & u_2^1 & v_2^1u_1^1 & v_2^1v_1^1 & v_2^1 & u_1^1 & v_1^1 &1 
  \\ u_2^2u_1^2 & u_2^2v_1^2 & u_2^2 & v_2^2u_1^2 & v_2^2v_1^2 & v_2^2 & u_1^2 & v_1^2 &1 
  \\ . & . & . & . & . & . & . & . & . 
  \\ . & . & . & . & . & . & . & . & . 
  \\ . & . & . & . & . & . & . & . & . 
  \\ u_8^2u_1^8 & u_2^8v_1^8 & u_2^8 & v_2^8u_1^8 & v_2^8v_1^8 & v_2^8 & u_1^8 & v_1^8 &1 
  \end{bmatrix} \begin{bmatrix} e_1 \\ e_2 \\ e_3 \\ e_4 \\ e_5 \\ e_6 \\ e_7 \\ e_8 \\ e_9 
  \end{bmatrix} = 0$$
  如果8对匹配点组成的矩阵满足秩为8的条件，那么$E$的各元素就可以由上诉方程得到。
  :::tip
  到这里，已经得到了本质矩阵$E$，根据它再分解出相机的运动 $R$、$t$需要采用奇异分解（SVD），分解后会得到4组解，不过分别把这4组解拿来运算就可以排除三项不合常规的。
  :::
- 单应矩阵
#### 6.1.3 三角测量

#### 6.1.4 3D-2D: PnP
- 直接线性变换
- P3P
- 最小化重投影误差求解PnP
#### 6.1.5 3D-3D ICP
- SVD 方法
- 非线性优化方法

